<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrx - {{contentType}}</title>
    <!-- Shared styles will be inlined by template loader -->
</head>
<body class="m-base">
    <div class="matrx-container">
        <!-- Content sections come first so :target works properly -->
        <div id="textContent" class="matrx-content-view matrx-text-view">{{textContent}}</div>
        <div id="formattedContent" class="matrx-content-view matrx-formatted-view">{{formattedHtml}}</div>
        
        <div class="matrx-header">
            <h1>
                <span class="m-icon m-icon-md m-icon-file-text" style="vertical-align: middle; margin-right: 8px;"></span>
                Matrx - {{contentType}}
            </h1>
            <p class="subtitle">AI-extracted clean text with dual viewing modes</p>
            <div class="matrx-header-actions">
                <a href="#textContent" class="matrx-btn matrx-view-toggle matrx-text-toggle m-btn m-btn-secondary">
                    <span class="m-icon m-icon-sm m-icon-file"></span>
                    Text View
                </a>
                <a href="#formattedContent" class="matrx-btn matrx-view-toggle matrx-formatted-toggle m-btn m-btn-secondary">
                    <span class="m-icon m-icon-sm m-icon-settings"></span>
                    Formatted View
                </a>
                <button class="matrx-btn m-btn m-btn-secondary" id="copyBtn">
                    <span class="m-icon m-icon-sm m-icon-copy"></span>
                    Copy Content
                </button>
            </div>
        </div>
        
        <div class="matrx-content-wrapper">
            <!-- Content is positioned here visually but defined above for :target -->
        </div>
    </div>

    <!-- Content is embedded directly in the page for direct clipboard access -->
    
        <script>
            // Store content directly in the page for direct clipboard access
            const TEXT_CONTENT = `{{textContentEncoded}}`;
            const FORMATTED_TEXT = `{{formattedTextEncoded}}`;
            
            // Visual debugging element (since console doesn't work in blob URLs)
            let debugDiv = null;
            
            function showDebug(message) {
                if (!debugDiv) {
                    debugDiv = document.createElement('div');
                    debugDiv.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 11px;
                        z-index: 10000;
                        max-width: 300px;
                        word-wrap: break-word;
                        font-family: monospace;
                        border: 1px solid #333;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    document.body.appendChild(debugDiv);
                }
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + (debugDiv.innerHTML || '');
                
                // Auto-hide debug after 8 seconds
                setTimeout(() => {
                    if (debugDiv && debugDiv.parentNode) {
                        debugDiv.style.opacity = '0.5';
                    }
                }, 8000);
            }
            
            showDebug(`Dual View loaded - Text: ${TEXT_CONTENT.length} chars, Formatted: ${FORMATTED_TEXT.length} chars`);
            
            // Direct clipboard access (should work with clipboardWrite permission)
            function setupCopyButton() {
                const copyBtn = document.getElementById('copyBtn');
                if (!copyBtn) {
                    showDebug('ERROR: Copy button not found!');
                    return;
                }
                
                showDebug('Copy button found and event listener attached');
                
                copyBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const isFormattedView = window.location.hash === '#formattedContent';
                    const contentToCopy = isFormattedView ? 
                        decodeURIComponent(FORMATTED_TEXT) : 
                        decodeURIComponent(TEXT_CONTENT);
                    
                    showDebug(`Copy clicked - View: ${isFormattedView ? 'formatted' : 'text'}, Length: ${contentToCopy.length}`);
                    
                    if (!contentToCopy || contentToCopy.length === 0) {
                        showDebug('ERROR: No content available');
                        showCopyFeedback(copyBtn, 'No Content', 'error');
                        return;
                    }
                    
                    try {
                        showDebug('Attempting direct clipboard access...');
                        
                        // Direct clipboard access - should work with clipboardWrite permission
                        await navigator.clipboard.writeText(contentToCopy);
                        showCopyFeedback(copyBtn, 'Copied!', 'success');
                        showDebug('SUCCESS: Content copied via navigator.clipboard');
                        
                    } catch (error) {
                        showDebug(`Clipboard API failed: ${error.message}, trying fallback...`);
                        
                        try {
                            // Fallback to execCommand method
                            const textArea = document.createElement('textarea');
                            textArea.value = contentToCopy;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-9999px';
                            textArea.style.top = '-9999px';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            
                            const success = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            if (success) {
                                showCopyFeedback(copyBtn, 'Copied!', 'success');
                                showDebug('SUCCESS: Content copied via execCommand fallback');
                            } else {
                                showCopyFeedback(copyBtn, 'Failed', 'error');
                                showDebug('ERROR: execCommand fallback failed');
                            }
                        } catch (fallbackError) {
                            showCopyFeedback(copyBtn, 'Error', 'error');
                            showDebug(`FALLBACK ERROR: ${fallbackError.message}`);
                        }
                    }
                });
            }
            
            // Enhanced feedback with animation
            function showCopyFeedback(button, text, type) {
                const originalText = button.textContent;
                const originalColor = button.style.color;
                
                // Update button text and color
                button.textContent = text;
                button.style.color = type === 'success' ? 'var(--m-success)' : 'var(--m-error)';
                button.style.transform = 'scale(1.05)';
                button.disabled = true;
                
                // Add pulse animation
                button.style.animation = 'pulse 0.3s ease-in-out';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.color = originalColor;
                    button.style.transform = 'scale(1)';
                    button.style.animation = '';
                    button.disabled = false;
                }, 2000);
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupCopyButton);
            } else {
                setupCopyButton();
            }
            
            // Debug hash changes
            window.addEventListener('hashchange', function() {
                showDebug('View switched to: ' + window.location.hash);
            });
            
            // Add click handler to debug div to hide it
            document.addEventListener('click', function(e) {
                if (e.target === debugDiv) {
                    debugDiv.style.display = 'none';
                }
            });
        </script>
</body>
</html>
